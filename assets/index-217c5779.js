import{r as a,j as t,aF as ce,br as ue,aG as he,h as i,ah as z,B as c,T as h,az as xe,aA as M,aC as me,k as j}from"./index-7e03851a.js";import{R as B}from"./react-qr-scanner.esm-dbcb4de2.js";import{L as pe}from"./ListItem-27ce892c.js";const Ae=()=>{const[S,g]=a.useState(!1),[U,C]=a.useState(!1),[x,l]=a.useState([]),[fe,G]=a.useState(null),[I,H]=a.useState(null),[je,b]=a.useState(!1),[E,N]=a.useState(null),[m,v]=a.useState(!1),[J,K]=a.useState(!1),[ge,V]=a.useState([]),[T,y]=a.useState(!1),[w,k]=a.useState(!1),[A,u]=a.useState(""),[W,Q]=a.useState(!1),[F,R]=a.useState(x),[X,D]=a.useState(!1),[_,Y]=a.useState(1),$=10,Z=(e,s)=>{Y(s)},O=x.slice((_-1)*$,_*$),ee=e=>{if(e){b(!0);const r=(e.text||"").match(/Sala_ID: (\d+)/);if(r!=null&&r[1]){const o=r[1];G(e),H(o),ne(o),setTimeout(()=>{b(!1)},2e3)}else console.error("Unrecognized QR code format."),b(!1)}},L=e=>{if(e){V(e);const s=/Inventario_Id:\s*(\d+)\s*\|\s*Item_Id:\s*(\d+)/,r=e.text.match(s);if(r){const o=parseInt(r[1]),d=r[2];de(d,"auditado",E,o)}else console.error("Dados de QR code inválidos")}},te=()=>{k(!0),L()},se=()=>{k(!1),y(!1),X&&l(e=>e.map(s=>s.status==="Item auditado"?{...s,status:"Auditado",isEdited:!0}:s))},P=e=>{console.error("Error scanning QR code:",e)},ae=()=>{g(!0)},re=()=>{g(!1)},ne=async e=>{try{const r=(await j.get(`/inventory/audits/${e}`)).data.items;l(r),C(!0),g(!1)}catch(s){console.error("Error fetching items:",s)}},oe=async()=>{if(I)try{const s=(await j.post(`/inventory/audits/${I}`)).data.audit_id;N(s),v(!0)}catch(e){console.error("Error starting audit:",e)}},ie=async()=>{if(I)try{const e=await j.post(`/inventory/audits/finish/${E}`);K(!0),g(!1),l([]),C(!1),v(!1)}catch(e){console.error("Error finishing audit:",e)}},de=async(e,s,r,o)=>{const d="Auditado";try{const p=await j.post(`/inventory/audits/item/${r}`,{item_id:e,inventario_id:o});l(f=>f.map(n=>n.id===e&&n.inventario_id===o?{...n,status:d,isEdited:!0}:n)),R(f=>f.map(n=>n.id===e&&n.inventario_id===o?{...n,status:d,isEdited:!0}:n)),u("Item auditado com sucesso!"),Q(!1),D(!0),setTimeout(()=>{u(""),D(!1)},3e3)}catch(p){console.error(`Error marking item as ${d}:`,p),u("Erro ao auditar o item. item já auditado."),Q(!0),setTimeout(()=>{u("")},3e3)}};a.useEffect(()=>{!w&&A&&R(e=>e.map(s=>s.status==="Auditado"?{...s,isEdited:!0}:s))},[w,A]);const le=async(e,s,r,o)=>{const d="Avaria";try{const p=await j.post(`/inventory/audits/item/avaria/${r}`,{item_id:e,inventario_id:o,observacoes:"Defeito"});l(f=>f.map(n=>n.id===e&&n.inventario_id===o?{...n,status:d,isEdited:!0}:n))}catch(p){console.error(`Error marking item ${e} as ${d}:`,p)}},q=()=>{l([]),C(!1),v(!1)};return t.jsxs(t.Fragment,{children:[t.jsxs(ce,{sx:{width:600,margin:"0 auto",mt:4},hidden:x.length>0,children:[t.jsx(ue,{title:"Criar Auditoria",sx:{textAlign:"center"}}),t.jsxs(he,{sx:{textAlign:"center"},children:[!S&&x.length===0&&t.jsx(i,{variant:"outlined",color:"primary",onClick:ae,children:"Ler QR Code"}),S&&t.jsxs("div",{children:[t.jsx(B,{onScan:ee,onError:()=>P,style:{width:"100%"}}),t.jsx(i,{variant:"outlined",color:"secondary",onClick:re,children:"Fechar camera"})]})]})]}),t.jsx(z,{open:U&&!T,onClose:()=>{C(!1),l([]),v(!1),y(!1)},"aria-labelledby":"modal-title","aria-describedby":"modal-description",children:t.jsxs(c,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"50%",bgcolor:"background.paper",boxShadow:24,p:4},children:[t.jsx(c,{sx:{display:"flex",justifyContent:"center"},children:t.jsx(h,{id:"modal-title",variant:"h6",component:"h2",children:"Lista de Itens"})}),t.jsxs(h,{id:"modal-description",sx:{mt:2},children:[t.jsx(xe,{children:O&&O.length>0?O.map(e=>e!=null&&e.status?t.jsx(pe,{children:t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",width:"100%"},children:[t.jsxs(h,{children:[e.nome,t.jsx(M,{label:e.status,color:e.status==="Auditado"?"success":"warning",variant:"light",size:"small",sx:{ml:1}})]}),e.isEdited&&t.jsx(h,{color:"success.main",sx:{ml:2},children:"✓ Feito"}),t.jsx(c,{children:m&&!S&&t.jsx(t.Fragment,{children:e.status==="Item não auditado"&&t.jsx(t.Fragment,{children:t.jsx(i,{variant:"outlined",color:"warning",onClick:()=>{le(e.id,"avaria",E,e.inventario_id)},disabled:e.status==="Avaria",sx:{mr:1},children:"Avaria"})})})})]})},`${e.id}-${e.inventario_id}`):null):t.jsx(h,{children:"Nenhum item disponível"})}),t.jsx(me,{count:Math.ceil(x.length/$),page:_,onChange:Z,sx:{display:"flex",justifyContent:"center",mt:2}})]}),t.jsx(c,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:F&&F.length>0&&F.every(e=>e.status==="Auditado"||e.status==="Item com avaria")?t.jsxs(t.Fragment,{children:[t.jsx(c,{sx:{flex:1,textAlign:"center"},children:t.jsx(h,{variant:"body1",color:"textSecondary",children:"Todos os itens já foram auditados"})}),t.jsx(i,{variant:"outlined",color:"primary",onClick:q,children:"Fechar"})]}):t.jsxs(t.Fragment,{children:[m&&t.jsx(i,{variant:"outlined",color:"success",onClick:()=>{te(),y(!0)},children:"Auditar"}),t.jsx(i,{variant:"text",color:"error",onClick:q,sx:{mr:1},children:"Cancelar Auditoria"}),m&&!J&&t.jsx(i,{variant:"outlined",color:"primary",onClick:ie,children:"Finalizar Auditoria"}),!m&&t.jsx(i,{variant:"outlined",color:"primary",onClick:oe,disabled:m,children:"Iniciar auditoria"})]})})]})}),t.jsx(z,{open:T,onClose:()=>{y(!1),k(!1),u("")},"aria-labelledby":"modal-title","aria-describedby":"modal-description",children:t.jsx(c,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"30%",bgcolor:"background.paper",boxShadow:24,p:4},children:w&&t.jsxs("div",{children:[A&&t.jsx(M,{label:A,color:W?"error":"success",onDelete:()=>{u("")},sx:{marginTop:2}}),t.jsx(B,{onScan:L,onError:P,style:{width:"100%"}}),t.jsx(i,{variant:"outlined",color:"secondary",onClick:se,children:"Fechar câmera"})]})})})]})};export{Ae as default};
