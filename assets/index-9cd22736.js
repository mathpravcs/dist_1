import{r as a,j as t,aF as xe,br as me,aG as pe,h as i,ah as q,B as c,T as h,az as fe,aA as z,aC as je,k as j}from"./index-82d1cb39.js";import{R as U}from"./react-qr-scanner.esm-7da369ed.js";import{L as ge}from"./ListItem-44174649.js";const be=()=>{const[O,G]=a.useState(!0),[S,g]=a.useState(!1),[H,C]=a.useState(!1),[x,l]=a.useState([]),[Ce,N]=a.useState(null),[I,J]=a.useState(null),[ve,b]=a.useState(!1),[E,K]=a.useState(null),[m,v]=a.useState(!1),[V,W]=a.useState(!1),[ye,X]=a.useState([]),[Q,y]=a.useState(!1),[k,w]=a.useState(!1),[A,u]=a.useState(""),[Y,R]=a.useState(!1),[F,D]=a.useState(x),[Z,L]=a.useState(!1),[_,ee]=a.useState(1),T=10,te=()=>{G(!O)},se=(e,s)=>{ee(s)},$=x.slice((_-1)*T,_*T),ae=e=>{if(e){b(!0);const r=(e.text||"").match(/Sala_ID: (\d+)/);if(r!=null&&r[1]){const o=r[1];N(e),J(o),de(o),setTimeout(()=>{b(!1)},2e3)}else console.error("Unrecognized QR code format."),b(!1)}},P=e=>{if(e){X(e);const s=/Inventario_Id:\s*(\d+)\s*\|\s*Item_Id:\s*(\d+)/,r=e.text.match(s);if(r){const o=parseInt(r[1]),d=r[2];ue(d,"auditado",E,o)}else console.error("Dados de QR code inválidos")}},re=()=>{w(!0),P()},ne=()=>{w(!1),y(!1),Z&&l(e=>e.map(s=>s.status==="Item auditado"?{...s,status:"Auditado",isEdited:!0}:s))},B=e=>{console.error("Error scanning QR code:",e)},oe=()=>{g(!0)},ie=()=>{g(!1)},de=async e=>{try{const r=(await j.get(`/inventory/audits/${e}`)).data.items;l(r),C(!0),g(!1)}catch(s){console.error("Error fetching items:",s)}},le=async()=>{if(I)try{const s=(await j.post(`/inventory/audits/${I}`)).data.audit_id;K(s),v(!0)}catch(e){console.error("Error starting audit:",e)}},ce=async()=>{if(I)try{const e=await j.post(`/inventory/audits/finish/${E}`);W(!0),g(!1),l([]),C(!1),v(!1)}catch(e){console.error("Error finishing audit:",e)}},ue=async(e,s,r,o)=>{const d="Auditado";try{const p=await j.post(`/inventory/audits/item/${r}`,{item_id:e,inventario_id:o});l(f=>f.map(n=>n.id===e&&n.inventario_id===o?{...n,status:d,isEdited:!0}:n)),D(f=>f.map(n=>n.id===e&&n.inventario_id===o?{...n,status:d,isEdited:!0}:n)),u("Item auditado com sucesso!"),R(!1),L(!0),setTimeout(()=>{u(""),L(!1)},3e3)}catch(p){console.error(`Error marking item as ${d}:`,p),u("Erro ao auditar o item. item já auditado."),R(!0),setTimeout(()=>{u("")},3e3)}};a.useEffect(()=>{!k&&A&&D(e=>e.map(s=>s.status==="Auditado"?{...s,isEdited:!0}:s))},[k,A]);const he=async(e,s,r,o)=>{const d="Avaria";try{const p=await j.post(`/inventory/audits/item/avaria/${r}`,{item_id:e,inventario_id:o,observacoes:"Defeito"});l(f=>f.map(n=>n.id===e&&n.inventario_id===o?{...n,status:d,isEdited:!0}:n))}catch(p){console.error(`Error marking item ${e} as ${d}:`,p)}},M=()=>{l([]),C(!1),v(!1)};return t.jsxs(t.Fragment,{children:[t.jsxs(xe,{sx:{width:600,margin:"0 auto",mt:4},hidden:x.length>0,children:[t.jsx(me,{title:"Criar Auditoria",sx:{textAlign:"center"}}),t.jsxs(pe,{sx:{textAlign:"center"},children:[!S&&x.length===0&&t.jsx(i,{variant:"outlined",color:"primary",onClick:oe,children:"Ler QR Code"}),S&&t.jsxs("div",{children:[t.jsx(U,{onScan:ae,onError:B,style:{width:"100%"},constraints:{facingMode:O?"environment":"user"}}),t.jsx(i,{variant:"outlined",color:"secondary",onClick:ie,children:"Fechar câmera"}),t.jsx(i,{variant:"outlined",color:"primary",onClick:te,sx:{mt:2},children:"Trocar câmera"})]})]})]}),t.jsx(q,{open:H&&!Q,onClose:()=>{C(!1),l([]),v(!1),y(!1)},"aria-labelledby":"modal-title","aria-describedby":"modal-description",children:t.jsxs(c,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"50%",bgcolor:"background.paper",boxShadow:24,p:4},children:[t.jsx(c,{sx:{display:"flex",justifyContent:"center"},children:t.jsx(h,{id:"modal-title",variant:"h6",component:"h2",children:"Lista de Itens"})}),t.jsxs(h,{id:"modal-description",sx:{mt:2},children:[t.jsx(fe,{children:$&&$.length>0?$.map(e=>e!=null&&e.status?t.jsx(ge,{children:t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",width:"100%"},children:[t.jsxs(h,{children:[e.nome,t.jsx(z,{label:e.status,color:e.status==="Auditado"?"success":"warning",variant:"light",size:"small",sx:{ml:1}})]}),e.isEdited&&t.jsx(h,{color:"success.main",sx:{ml:2},children:"✓ Feito"}),t.jsx(c,{children:m&&!S&&t.jsx(t.Fragment,{children:e.status==="Item não auditado"&&t.jsx(t.Fragment,{children:t.jsx(i,{variant:"outlined",color:"warning",onClick:()=>{he(e.id,"avaria",E,e.inventario_id)},disabled:e.status==="Avaria",sx:{mr:1},children:"Avaria"})})})})]})},`${e.id}-${e.inventario_id}`):null):t.jsx(h,{children:"Nenhum item disponível"})}),t.jsx(je,{count:Math.ceil(x.length/T),page:_,onChange:se,sx:{display:"flex",justifyContent:"center",mt:2}})]}),t.jsx(c,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:F&&F.length>0&&F.every(e=>e.status==="Auditado"||e.status==="Item com avaria")?t.jsxs(t.Fragment,{children:[t.jsx(c,{sx:{flex:1,textAlign:"center"},children:t.jsx(h,{variant:"body1",color:"textSecondary",children:"Todos os itens já foram auditados"})}),t.jsx(i,{variant:"outlined",color:"primary",onClick:M,children:"Fechar"})]}):t.jsxs(t.Fragment,{children:[m&&t.jsx(i,{variant:"outlined",color:"success",onClick:()=>{re(),y(!0)},children:"Auditar"}),t.jsx(i,{variant:"text",color:"error",onClick:M,sx:{mr:1},children:"Cancelar Auditoria"}),m&&!V&&t.jsx(i,{variant:"outlined",color:"primary",onClick:ce,children:"Finalizar Auditoria"}),!m&&t.jsx(i,{variant:"outlined",color:"primary",onClick:le,disabled:m,children:"Iniciar auditoria"})]})})]})}),t.jsx(q,{open:Q,onClose:()=>{y(!1),w(!1),u("")},"aria-labelledby":"modal-title","aria-describedby":"modal-description",children:t.jsx(c,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"30%",bgcolor:"background.paper",boxShadow:24,p:4},children:k&&t.jsxs("div",{children:[A&&t.jsx(z,{label:A,color:Y?"error":"success",onDelete:()=>{u("")},sx:{marginTop:2}}),t.jsx(U,{onScan:P,onError:B,style:{width:"100%"}}),t.jsx(i,{variant:"outlined",color:"secondary",onClick:ne,children:"Fechar câmera"})]})})})]})};export{be as default};
